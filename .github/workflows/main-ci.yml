name: "🚀 Main CI Pipeline"

on:
  pull_request:
    branches: [main]  # Added dev branch
  push:
    branches: [main]  # Added dev branch

jobs:
  validate-pom:
    name: "📦 Validate POM"  # Exact name for branch protection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils
          chmod +x ./scripts/validate-pom.sh

      - name: Validate POM
        run: |
          xmllint --noout pom.xml || (echo "::error::Malformed XML in pom.xml"; exit 1)
          ./scripts/validate-pom.sh --strict --html

      - uses: actions/upload-artifact@v4
        name: 📦 Upload POM Report
        with:
          name: pom-validation-report
          path: Reports/pom-validation-report.html

  build:
    name: "🏗️ Build & Test"
    needs: validate-pom
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - run: mvn -B clean verify
      - uses: actions/upload-artifact@v4
        name: 📊 Upload Test Results
        with:
          name: test-results-${{ github.run_id }}
          path: |
            target/surefire-reports/**
            target/failsafe-reports/**

  security:
  name: "🔒 Dependency Security"
  needs: validate-pom
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 21

    - name: Cache OWASP dependency-check data
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository/org/owasp/dependency-check-data
        key: owasp-db-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          owasp-db-${{ runner.os }}-

    - name: Run OWASP Dependency Check
      run: mvn org.owasp:dependency-check-maven:check

  quality:
    name: "📊 Code Quality"
    needs: validate-pom
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - run: mvn checkstyle:check
